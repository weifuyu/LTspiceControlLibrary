Version 4
SHEET 1 2028 1940
WIRE 576 464 336 464
WIRE 832 464 576 464
WIRE 1056 464 832 464
WIRE 576 496 576 464
WIRE 656 496 576 496
WIRE 832 496 832 464
WIRE 912 496 832 496
WIRE 1056 496 1056 464
WIRE 1136 496 1056 496
WIRE 576 512 576 496
WIRE 656 512 656 496
WIRE 832 512 832 496
WIRE 912 512 912 496
WIRE 1056 512 1056 496
WIRE 1136 512 1136 496
WIRE 576 608 576 592
WIRE 656 608 656 576
WIRE 656 608 576 608
WIRE 832 608 832 592
WIRE 912 608 912 576
WIRE 912 608 832 608
WIRE 1056 608 1056 592
WIRE 1136 608 1136 576
WIRE 1136 608 1056 608
WIRE 576 672 576 608
WIRE 1088 672 576 672
WIRE 1248 672 1088 672
WIRE 336 720 336 464
WIRE 1248 720 1248 672
WIRE 1280 720 1248 720
WIRE 1424 720 1408 720
WIRE 1536 720 1520 720
WIRE 1552 720 1536 720
WIRE 1552 736 1552 720
WIRE 832 768 832 608
WIRE 1088 768 832 768
WIRE 1280 768 1088 768
WIRE 1280 816 1248 816
WIRE 1424 816 1408 816
WIRE 1552 816 1424 816
WIRE 1056 864 1056 608
WIRE 1088 864 1056 864
WIRE 1248 864 1248 816
WIRE 1248 864 1088 864
WIRE 1424 880 1424 816
WIRE 576 912 576 672
WIRE 656 912 576 912
WIRE 832 912 832 768
WIRE 912 912 832 912
WIRE 1056 912 1056 864
WIRE 1136 912 1056 912
WIRE 576 928 576 912
WIRE 832 928 832 912
WIRE 1056 928 1056 912
WIRE 656 944 656 912
WIRE 912 944 912 912
WIRE 1136 944 1136 912
WIRE 576 1024 576 1008
WIRE 656 1024 656 1008
WIRE 656 1024 576 1024
WIRE 832 1024 832 1008
WIRE 912 1024 912 1008
WIRE 912 1024 832 1024
WIRE 1056 1024 1056 1008
WIRE 1136 1024 1136 1008
WIRE 1136 1024 1056 1024
WIRE 336 1056 336 800
WIRE 576 1056 576 1024
WIRE 576 1056 336 1056
WIRE 832 1056 832 1024
WIRE 832 1056 576 1056
WIRE 1056 1056 1056 1024
WIRE 1056 1056 832 1056
WIRE 336 1088 336 1056
WIRE 688 1296 672 1296
WIRE 800 1296 752 1296
WIRE 896 1296 864 1296
WIRE 1328 1296 1312 1296
WIRE 896 1328 880 1328
WIRE 1104 1344 1072 1344
WIRE 528 1360 432 1360
WIRE 672 1360 672 1296
WIRE 672 1360 656 1360
WIRE 896 1360 672 1360
WIRE 1312 1360 1312 1296
WIRE 1312 1360 1296 1360
WIRE 1392 1360 1312 1360
WIRE 1104 1376 1088 1376
WIRE 1712 1392 1616 1392
WIRE 560 1424 560 1392
WIRE 560 1424 432 1424
WIRE 1088 1424 1088 1376
WIRE 1584 1424 1552 1424
WIRE 1648 1456 1616 1456
WIRE 1712 1456 1696 1456
WIRE 624 1488 624 1392
WIRE 624 1488 432 1488
WIRE 1584 1488 1552 1488
WIRE 1680 1488 1632 1488
WIRE 1712 1520 1616 1520
WIRE 672 1536 672 1360
WIRE 688 1536 672 1536
WIRE 1584 1552 1552 1552
WIRE 960 1568 912 1568
WIRE 1104 1568 1056 1568
WIRE 1136 1568 1136 1408
WIRE 1136 1568 1104 1568
WIRE 1648 1584 1616 1584
WIRE 1712 1584 1696 1584
WIRE 960 1616 944 1616
WIRE 1584 1616 1552 1616
WIRE 1632 1616 1632 1488
WIRE 1680 1616 1632 1616
WIRE 1712 1648 1616 1648
WIRE 1584 1680 1552 1680
WIRE 1648 1712 1616 1712
WIRE 1712 1712 1696 1712
WIRE 1584 1744 1552 1744
WIRE 1632 1744 1632 1616
WIRE 1680 1744 1632 1744
WIRE 432 1776 400 1776
WIRE 464 1776 432 1776
WIRE 544 1776 528 1776
WIRE 640 1776 608 1776
WIRE 784 1776 640 1776
WIRE 816 1776 784 1776
WIRE 896 1776 880 1776
WIRE 912 1776 896 1776
WIRE 1040 1776 1024 1776
WIRE 1088 1776 1040 1776
WIRE 1136 1776 1088 1776
WIRE 1232 1776 1200 1776
WIRE 1632 1776 1632 1744
WIRE 1632 1776 1232 1776
WIRE 496 1808 480 1808
WIRE 896 1808 896 1776
WIRE 640 1824 640 1776
WIRE 784 1824 768 1824
WIRE 848 1824 848 1808
WIRE 848 1824 784 1824
WIRE 400 1840 400 1776
WIRE 1040 1840 1040 1776
WIRE 1040 1840 928 1840
WIRE 1168 1840 1168 1808
WIRE 672 1888 672 1856
WIRE 896 1888 896 1872
WIRE 896 1888 672 1888
FLAG 336 1088 0
FLAG 528 528 UP
FLAG 528 576 0
FLAG 1088 672 U
FLAG 528 944 UN
FLAG 528 992 0
FLAG 784 528 VP
FLAG 784 576 0
FLAG 784 944 VN
FLAG 784 992 0
FLAG 1088 768 V
FLAG 336 464 DC_P
FLAG 1008 528 WP
FLAG 1008 576 0
FLAG 1008 944 WN
FLAG 1008 992 0
FLAG 1088 864 W
FLAG 1424 880 0
FLAG 1536 720 tm
FLAG 1440 768 hu
FLAG 1472 768 hv
FLAG 1504 768 hw
FLAG 1360 1552 hu
FLAG 1360 1600 hv
FLAG 1360 1648 hw
FLAG 1424 1552 nhu
FLAG 1424 1600 nhv
FLAG 1424 1648 nhw
FLAG 1552 1456 hu
FLAG 1552 1488 nhv
FLAG 1552 1392 nhu
FLAG 1552 1424 hv
FLAG 1552 1584 hv
FLAG 1552 1616 nhw
FLAG 1552 1520 nhv
FLAG 1552 1552 hw
FLAG 1552 1712 hw
FLAG 1552 1744 nhu
FLAG 1552 1648 nhw
FLAG 1552 1680 hu
FLAG 1712 1392 UP
FLAG 1712 1456 UN
FLAG 1712 1520 VP
FLAG 1712 1584 VN
FLAG 1712 1648 WP
FLAG 1712 1712 WN
FLAG 1168 1920 0
FLAG 1232 1776 pwm
FLAG 368 1360 hu
FLAG 368 1424 hv
FLAG 368 1488 hw
FLAG 880 1328 0
FLAG 1392 1360 oe_hs
FLAG 1392 1296 om_hs
FLAG 944 1616 0
FLAG 1088 1504 0
FLAG 400 1920 0
FLAG 432 1776 om*
FLAG 784 1776 m*_p
FLAG 784 1824 m*_i
FLAG 1088 1776 m*
FLAG 480 1808 om_hs
FLAG 1104 1568 startup
SYMBOL voltage 336 704 R0
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName V1
SYMATTR Value 100
SYMBOL diode 640 576 M180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D1
SYMBOL sw 576 608 M180
SYMATTR InstName S1
SYMBOL sw 576 1024 M180
SYMATTR InstName S2
SYMBOL sw 832 608 M180
SYMATTR InstName S3
SYMBOL sw 832 1024 M180
SYMATTR InstName S4
SYMBOL diode 640 1008 M180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D2
SYMBOL diode 896 576 M180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D3
SYMBOL diode 896 1008 M180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D4
SYMBOL sw 1056 608 M180
SYMATTR InstName S5
SYMBOL sw 1056 1024 M180
SYMATTR InstName S6
SYMBOL diode 1120 576 M180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D5
SYMBOL diode 1120 1008 M180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D6
SYMBOL voltage 1552 720 R0
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName V2
SYMATTR Value PULSE(0 3 20m 100m 100m 1G)
SYMBOL Motors\\PMSMotor 1408 768 R0
SYMATTR InstName U1
SYMATTR Value Ra=0.1 Ld=1m Lq=1m Ke=0.1 Dm=0.1m Jm=0.1m Np={Np}
SYMBOL Sensors\\3HallSensors 1552 592 R0
WINDOW 123 -128 53 Left 2
SYMATTR Value2 Pm0={-Pdelay/Np}
SYMATTR Value Np={Np}
SYMATTR InstName U2
SYMBOL Math\\Operands\\inv_op 1376 1584 R0
SYMATTR InstName U3
SYMBOL Math\\Operands\\inv_op 1376 1632 R0
SYMATTR InstName U4
SYMBOL Math\\Operands\\inv_op 1376 1680 R0
SYMATTR InstName U5
SYMBOL Math\\Operands\\and_op 1568 1488 R0
SYMATTR InstName U6
SYMBOL Math\\Operands\\and_op 1568 1424 R0
SYMATTR InstName U7
SYMBOL Math\\Operands\\and_op 1568 1616 R0
SYMATTR InstName U8
SYMBOL Math\\Operands\\and_op 1568 1552 R0
SYMATTR InstName U9
SYMBOL Math\\Operands\\and_op 1568 1744 R0
SYMATTR InstName U10
SYMBOL Math\\Operands\\and_op 1568 1680 R0
SYMATTR InstName U11
SYMBOL gt 1152 1808 R0
SYMATTR InstName U12
SYMBOL TriangleWaveVoltage 1168 1824 R0
SYMATTR InstName U13
SYMATTR Value V1=0 V2=1 Tperiod={Tcarrier} tratio=1
SYMBOL Math\\Operands\\and_op 1664 1488 R0
SYMATTR InstName U14
SYMBOL Math\\Operands\\and_op 1664 1616 R0
SYMATTR InstName U15
SYMBOL Math\\Operands\\and_op 1664 1744 R0
SYMATTR InstName U16
SYMBOL SpecialFunctions\\sample 976 1328 R0
WINDOW 3 -64 -52 Left 2
SYMATTR Value Vhigh=1T Vlow=0
SYMATTR InstName A1
SYMBOL Digital\\buf1 688 1232 R0
WINDOW 39 -7 95 Left 2
SYMATTR SpiceLine Td={Tedge}
SYMATTR InstName A2
SYMBOL TransferFunctions\\Proportional 1248 1392 R0
SYMATTR Value K={2*pi/6*Fclk}
SYMATTR InstName U17
SYMBOL Math\\Operands\\rcp 1184 1392 R0
SYMATTR InstName U18
SYMBOL Math\\Operands\\or_op 544 1392 R0
SYMATTR InstName U19
SYMBOL Math\\Operands\\or_op 608 1392 R0
SYMATTR InstName U20
SYMBOL TransferFunctions\\Proportional 1344 1328 R0
SYMATTR Value K={1/Np}
SYMATTR InstName U21
SYMBOL PulseModulations\\BothEdgesDetector 384 1392 R0
SYMATTR Value Tedge={Tedge}
SYMATTR InstName U22
SYMBOL PulseModulations\\BothEdgesDetector 384 1456 R0
SYMATTR Value Tedge={Tedge}
SYMATTR InstName U23
SYMBOL PulseModulations\\BothEdgesDetector 384 1520 R0
SYMATTR Value Tedge={Tedge}
SYMATTR InstName U24
SYMBOL Digital\\srflop 1008 1520 R0
SYMATTR InstName A3
SYMBOL Math\\Functions\\if 1120 1408 R0
SYMATTR InstName U25
SYMBOL voltage 1088 1408 R0
SYMATTR InstName V3
SYMATTR Value 1T
SYMBOL PulseModulations\\PulseTimer 816 1328 R0
SYMATTR Value F={Fclk}
SYMATTR InstName U26
SYMBOL Digital\\counter 768 1504 R0
WINDOW 3 -64 -52 Left 2
SYMATTR Value cycles=2*2
SYMATTR InstName A4
SYMBOL voltage 400 1824 R0
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName V4
SYMATTR Value PULSE(0 100 0 1n 1n 1G)
SYMBOL sub 480 1808 R0
SYMATTR InstName U27
SYMBOL Proportional 560 1808 R0
SYMATTR Value K=2m
SYMATTR InstName U28
SYMBOL add 832 1808 R0
SYMATTR InstName U29
SYMBOL TransferFunctions\\Integral 720 1856 R0
SYMATTR Value T=10m
SYMATTR InstName U30
SYMBOL Math\\Functions\\limit 928 1808 R0
SYMATTR Value y=0 z=1+1m
SYMATTR InstName U31
SYMBOL Math\\Operands\\sub 928 1824 M90
SYMATTR InstName U32
SYMBOL sub 656 1856 R0
SYMATTR InstName U33
TEXT 328 304 Left 2 !.tran 200m startup
TEXT 328 336 Left 2 !.model SW SW(Ron=.1 Roff=10k Vt=0.5)\n.model D D(Ron=.1 Roff=10k Vfwd=.4)
TEXT 288 264 Left 4 ;Config
TEXT 248 208 Left 5 ;PMSM 120-Degree Drive with Hall Sensors
TEXT 288 400 Left 4 ;Circuit
TEXT 296 1160 Left 4 ;Controller
TEXT 1200 416 Left 2 ;Analogy between\nElectric Circuit  - Rotating Machinery\nQ: charge - Pm: angle\nI: current - Om: angular velocity\nV: voltage - Tm: torque\nR: resistance - Dm: viscous resistance\nL: inductance - Jm: moment of inertia\nC: capacitance - Km: torsion coefficient
TEXT 1608 752 Left 2 ;disturbance torque
TEXT 1144 1712 Left 2 ;pwm
TEXT 352 1312 Left 2 !.param Tedge=1n
TEXT 328 1216 Left 2 ;speed calcurator
TEXT 1288 952 Left 2 !.param Np=3\n.param Plead=pi/24 Pdelay=pi/6-Plead
TEXT 328 1720 Left 2 ;speed controller
TEXT 720 1912 Left 2 ;antiwindup
TEXT 840 1224 Left 2 !.param Fclk=1Meg
TEXT 1536 1320 Left 2 ;120-degree drive\nlow side pwm
TEXT 928 1488 Left 2 ;startup wait
TEXT 1304 1848 Left 2 !.param Tcarrier=100u
